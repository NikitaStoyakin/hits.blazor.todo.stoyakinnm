@page "/expert"
@using TodoBotApp.Services
@using TodoBotApp.Data.Models
@using System.Security.Claims
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Expert")]
@rendermode InteractiveServer

<PageTitle>–ü–∞–Ω–µ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞</PageTitle>

<h1>–ü–∞–Ω–µ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞</h1>

<div class="info-banner">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <p style="margin: 0;">üìã –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ <strong>–±–æ—Ç –Ω–µ —Å–º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å</strong> –∏–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —ç–∫—Å–ø–µ—Ä—Ç—É –≤—Ä—É—á–Ω—É—é.</p>
        <button type="button" 
                class="btn-refresh" 
                @onclick="LoadQuestionsAsync"
                disabled="@isLoading"
                title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤">
            üîÑ @(isLoading ? "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..." : "–û–±–Ω–æ–≤–∏—Ç—å")
        </button>
    </div>
</div>

@if (isLoading)
{
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...</p>
}
else if (pendingQuestions.Any())
{
    <div class="questions-list">
        <h2>–í–æ–ø—Ä–æ—Å—ã, –æ–∂–∏–¥–∞—é—â–∏–µ –æ—Ç–≤–µ—Ç–∞ (@pendingQuestions.Count)</h2>
        
        @foreach (var question in pendingQuestions)
        {
            <div class="question-card @(selectedQuestionId == question.Id ? "selected" : "")">
                <div class="question-header" @onclick="() => SelectQuestion(question.Id)">
                    <div class="question-info">
                        <strong>–í–æ–ø—Ä–æ—Å #@question.Id</strong>
                        <span class="question-date">@question.CreatedAt.ToString("dd.MM.yyyy HH:mm")</span>
                    </div>
                    <div class="question-status">
                        <span class="status-badge status-@question.Status.ToString().ToLower()">
                            @GetStatusDisplayName(question.Status)
                        </span>
                    </div>
                </div>
                
                <div class="question-content">
                    <p><strong>–í–æ–ø—Ä–æ—Å:</strong> @question.Question</p>
                </div>

                @if (selectedQuestionId == question.Id)
                {
                    <div class="answer-section">
                        @if (question.Status == ExpertQuestionStatus.Answered && !string.IsNullOrEmpty(question.Answer))
                        {
                            <div class="existing-answer">
                                <strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong>
                                <p>@question.Answer</p>
                                <small>–û—Ç–≤–µ—Ç –¥–∞–Ω: @question.AnsweredAt?.ToString("dd.MM.yyyy HH:mm")</small>
                            </div>
                        }
                        else
                        {
                            <div class="answer-form">
                                <label>–í–∞—à –æ—Ç–≤–µ—Ç:</label>
                                <textarea @bind="answerText" 
                                          class="answer-textarea" 
                                          placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å..."
                                          rows="5"></textarea>
                                <div class="answer-actions">
                                    <button type="button" 
                                            class="btn-submit-answer" 
                                            @onclick="() => SubmitAnswer(question.Id)"
                                            disabled="@string.IsNullOrWhiteSpace(answerText)">
                                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    <div class="no-questions">
        <p>–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö –æ—Ç–≤–µ—Ç–∞.</p>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="error-message">
        @errorMessage
    </div>
}

<style>
    .questions-list {
        margin-top: 20px;
    }

    .question-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 15px;
        padding: 15px;
        background: white;
        transition: box-shadow 0.2s;
    }

    .question-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .question-card.selected {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.2);
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
        margin-bottom: 10px;
    }

    .question-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .question-date {
        font-size: 12px;
        color: #666;
    }

    .question-content {
        margin: 10px 0;
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-pending {
        background: #ffc107;
        color: #000;
    }

    .status-inprogress {
        background: #17a2b8;
        color: white;
    }

    .status-answered {
        background: #28a745;
        color: white;
    }

    .answer-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #007bff;
    }

    .answer-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .answer-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-family: inherit;
        font-size: 14px;
    }

    .answer-actions {
        display: flex;
        gap: 10px;
    }

    .btn-submit-answer {
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-submit-answer {
        background: #28a745;
        color: white;
    }

    .btn-submit-answer:hover:not(:disabled) {
        background: #218838;
    }

    .btn-submit-answer:disabled {
        background: #ccc;
        cursor: not-allowed;
    }


    .existing-answer {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #28a745;
    }

    .no-questions {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .error-message {
        background: #ffcccc;
        color: #d8000c;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
    }

    .info-banner {
        background: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
    }

    .info-banner p {
        margin: 0;
        color: #004085;
    }


    .btn-refresh {
        padding: 8px 16px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        white-space: nowrap;
        margin-left: 15px;
        transition: background 0.2s;
    }

    .btn-refresh:hover:not(:disabled) {
        background: #0056b3;
    }

    .btn-refresh:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>

@code {
    [Inject] private IExpertService ExpertService { get; set; } = null!;
    [Inject] private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = null!;
    [Inject] private ILogger<Expert> Logger { get; set; } = null!;

    private List<ExpertQuestion> pendingQuestions = new();
    private int? selectedQuestionId = null;
    private string answerText = "";
    private bool isLoading = true;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadQuestionsAsync();
    }

    private async Task LoadQuestionsAsync()
    {
        try
        {
            isLoading = true;
            pendingQuestions = await ExpertService.GetPendingQuestionsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–æ–ø—Ä–æ—Å–æ–≤");
            errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void SelectQuestion(int questionId)
    {
        if (selectedQuestionId == questionId)
        {
            selectedQuestionId = null;
            answerText = "";
        }
        else
        {
            selectedQuestionId = questionId;
            var question = pendingQuestions.FirstOrDefault(q => q.Id == questionId);
            if (question != null && !string.IsNullOrEmpty(question.Answer))
            {
                answerText = question.Answer;
            }
            else
            {
                answerText = "";
            }
        }
        StateHasChanged();
    }

    private async Task SubmitAnswer(int questionId)
    {
        if (string.IsNullOrWhiteSpace(answerText))
            return;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var expertId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

            if (string.IsNullOrEmpty(expertId))
            {
                errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–∞.";
                return;
            }

            var success = await ExpertService.AnswerQuestionAsync(questionId, expertId, answerText);

            if (success)
            {
                // –£–¥–∞–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Ç–µ–ø–µ—Ä—å –æ—Ç–≤–µ—á–µ–Ω
                var question = pendingQuestions.FirstOrDefault(q => q.Id == questionId);
                if (question != null)
                {
                    pendingQuestions.Remove(question);
                }

                answerText = "";
                selectedQuestionId = null;
                errorMessage = "";
                Logger.LogInformation("–≠–∫—Å–ø–µ—Ä—Ç –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å. QuestionId: {QuestionId}, ExpertId: {ExpertId}", questionId, expertId);
            }
            else
            {
                errorMessage = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞");
            errorMessage = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
            StateHasChanged();
        }
    }


    private string GetStatusDisplayName(ExpertQuestionStatus status)
    {
        return status switch
        {
            ExpertQuestionStatus.Pending => "–û–∂–∏–¥–∞–µ—Ç",
            ExpertQuestionStatus.InProgress => "–í —Ä–∞–±–æ—Ç–µ",
            ExpertQuestionStatus.Answered => "–û—Ç–≤–µ—á–µ–Ω–æ",
            ExpertQuestionStatus.Resolved => "–†–µ—à–µ–Ω–æ",
            _ => status.ToString()
        };
    }
}

